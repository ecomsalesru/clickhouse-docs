# Документация таблиц Clickhouse

Owner: Ilnur Ibatullin
Tags: Clickhouse, Документация
Last edited time: April 19, 2024 6:47 PM

# Обновления

- 2024-04-19
    - searchesDict: preset
    - 
- 2024-02-12. Добавлено описание `selectedSeo`
- 2024-01-29. добавлено описание таблицы `feedbacksInfoHistory`
- 2024-01-16. добавлены таблицы `autoAds, hourlySeo`.
    - `productHistories`(added `stocks.*`),
    - `feedbacks`(added `colors`, `updatedAt`, removed `answerState`)
    - `productTexts`(added `contents`, `compositions`)
    - `searchInfoHistory`(added `normQuery`, `preset`)
    
    Удалена таблица `productStocks`, теперь сами остатки хранятся в таблице `productHistories` и нет нужды три раза в день парсить остатки и хранить избыточно остатки. высокочастотные остатки по-прежнему есть в таблице `stocks`
    

- 2023-10-18: в таблице `productStats` добавлены `country`, `volume`, `weight`, `numberOfItems`
- 2023-11-08
    - в таблице `searchesDict` добавлены три столбца - `normQuery, lastDate, goodsCount, subjects.id, subjects.count`
- 2023-11-17: `productHistories` и `productStats` добавлен столбец `promoText` - акция где товар участвует

# Таблицы

## `searchesDict`

Каждый день скачивается 1млн самых популярных запросов из портала ВБ, частотность берется за месяц

| столбец | тип | для чего |
| --- | --- | --- |
| `id` | `int` | сквозной идентификатор поискового запроса, используется в таблице `searchPositions`, `searchInfoHistories` |
| `text` | `String` | Текст поискового запроса |
| `requestCount` | `int` | Частотность запроса. Актуальное значение(вчера-сегодня) |
| `normQuery` | `String` | Кластер запроса |
| `lastDate` | `DateTime` | Дата последнего обновления запроса |
| `subjects.id` | `Array(int)` | массив номеров предметов, которые входят в этот запрос |
| `subjects.count` | `Array(int)` | массив количества предметов, которые входят в этот запрос |
| `goodsCount` | `int` | количество товаров в запросе |
| `preset` | `String` | Пресет |

## `subjects`

Таблица с названиями предметов. Предметы - двухуровневые, не путать с деревом категорий на ВБ.

На данный момент(сентябрь 2023) обновляется в ручном режиме. Если каких-то предметов нет в списке - пишите мнe в телеграм [t.me/ilnur_ibatullin](http://t.me/ilnur_ibatullin)

| столбец | тип | для чего |
| --- | --- | --- |
| `id` | `int` | Номер предмета из ВБ. |
| `name` | `String` | Имя предмета |
| `parentId` | `int` | Номер родительского предмета |
| `parentName` | `String` | Имя родительского предмета |

## `searchPositions`

Поисковая выдача

Сбор данных по поисковой выдаче по 1 млн популярных запросов из портала ВБ.

Если частотность выше 5 тыс в месяц, то парсится 10 разных ПВЗ. Из них 5 в Москве - центр, север, юг, запад и восток и 5 городов - Санкт-Петербург, Казань, Краснодар, Екатеринбург, Новосибирск. Плюс, парсится до 10 страниц в глубину

список 10 пвз, откуда делается парсинг:

| `MOSCOW_CENTER` | [большой Афанасьевский переулок, 22](https://go.2gis.com/daydtv)  |
| --- | --- |
| `MOSCOW_EAST` | [Оршанская, 9](https://go.2gis.com/8hbyq7) |
| `MOSCOW_SOUTH` | [Красного Маяка, 4к1](https://go.2gis.com/stbkb) |
| `MOSCOW_WEST` | [Зеленый проспект, 83](https://go.2gis.com/i28hd) |
| `MOSCOW_NORTH` | [Полярная, 27к2](https://go.2gis.com/5je78) |
| `PITER` | [Коллонтай 5/1](https://go.2gis.com/3piqxs) |
| `KRASNODAR` | [Восточно-Кругликовская, 28](https://go.2gis.com/rhqv9) |
| `KAZAN` | [Пушкина 16/2](https://go.2gis.com/c30z1) |
| `EKAT` | [Куйбышева, 121](https://go.2gis.com/tfnn8) |
| `NOVOSIB` | [Кошурникова 22/2](https://go.2gis.com/peuec) |

Если частотность ниже 5 тысяч в месяц, то парсится только по Москва.Центр, до 10 страниц в глубину

Если частотность ниже 500 то парсится только первая страница в выдаче по пвз Москва.Центр

Автокампании тоже здесь учитываются

| столбец | тип | для чего |
| --- | --- | --- |
| `productId` | `int` | Артикул товара |
| `date` | `Date` | Дата парсинга |
| `dest` | `Enum(String)` | Возможные варианты 
`MOSCOW_CENTER
MOSCOW_EAST
MOSCOW_SOUTH
MOSCOW_WEST
MOSCOW_NORTH
PITER
KRASNODAR
KAZAN
EKAT
NOVOSIB` |
| `searchKeyId` | `int` | идентификатор поискового запроса |
| `position` | `int` | Позиция товара в эту дату в поисковом запросе |
| `autoAdCpm` | `int` | рекламная ставка в авторекламе |
| `autoAdPromotion` | `int` | – |
| `autoAdPosition` | `int` | какая позиция была бы при отключенной автокампании |
| `autoAdPromoPosition` | `int` | какая актуальная позиция автокампании. Позиция начинается с нуля, поэтому если здесь стоит значение 10, значит фактически он находится на 11 месте, ровно такое же значение указано в столбце position |
| `autoAdAdvertId` | `int` | Идентификатор рекламной кампании |
| `sellerId` | `int` | Идентификатор селлера |

В этой таблице очень много данных, в среднем каждый день появляется порядка 500млн строк, поэтому запросы нужно делать строго с фильтром по артикулам. Например `select * from searchPositions where id = 12341234`

Если нужно выбрать все артикулы конкретного селлера, то лучше всего сходить в таблицу `productStats` за артикулами и по ним сделать запрос. Или вот так:

```sql
select * 
from searchPositions 
where id in (
	select id 
	from productStats
	where sellerId = <sellerId>
)
```

Все строки этой таблицы в одной `power Bi` вряд ли кому-то пригодятся, с другой стороны это просто не влезет в память компьютера. Поэтому нужно выбирать данные строго по фильтрам

## `hourlySeo`

Имеет аналогичную струткуру, как и `searchPositions`, исключение: столбец `date(Date)` → `parsedAt(DateTime)`

Парсится каждый час, только выбранные поисковые запросы. Изначально было примерно 4000 выбранных поисковых запросов, парсинг по всем гео-позициям, до 10 страниц в глубину. Список запросов может меняться по желанию заказчика

## `autoAds`

Имеет аналогичную струткуру, как и `searchPositions`, исключение: столбец `date(Date)` → `parsedAt(DateTime)`

Парсится только первые страницы поисковых запросов с частотностью более 5000 в месяц и с `dest: MOSCOW_CENTER`

Парсится раз в час. Хранится только рекламные позиции, остальные позиции, не авторекламные, игнорируются

## `selectedSeo`

Имеет похожую на `searchPositions`. Таблица заполняется по мере запуска парсинга через бота

| столбец | тип | для чего |
| --- | --- | --- |
| `productId` | `int`  | Артикул товара |
| `searchKeyId` | `int` | идентификатор поискового запроса |
| `parsedAt` | `DateTime` | Дата парсинга |
| `parseId` | `Int64` | идентификатор парсинга. unix_timestamp, по этому полю можно вытащить дату/время парсинга. и по этому полю нужно группировать запуски парсинга.  |
| `dest` | `Enum(String)` | Возможные варианты 
`MOSCOW_CENTER
MOSCOW_EAST
MOSCOW_SOUTH
MOSCOW_WEST
MOSCOW_NORTH
PITER
KRASNODAR
KAZAN
EKAT
NOVOSIB` |
| `position` | `int` | Позиция товара в эту дату в поисковом запросе |
| `autoAdCpm` | `int` | рекламная ставка в авторекламе |
| `autoAdPosition` | `int` | какая позиция была бы при отключенной автокампании |
| `autoAdPromotion` | `int` | – |
| `autoAdPromoPosition` | `int` | какая актуальная позиция автокампании. Позиция начинается с нуля, поэтому если здесь стоит значение 10, значит фактически он находится на 11 месте, ровно такое же значение указано в столбце position |
| `autoAdAdvertId` | `int` | Идентификатор рекламной кампании |
| `sellerId` | `int` | Идентификатор селлера |

## `productHistories`

Таблица с историей товаров. Обновляется раз в день, если нужно следить за изменением СПП три раза в день - смотрите в `productStocks`, там больше 1 раза в день можно отслеживать. 

| столбец | тип данных | описание |
| --- | --- | --- |
| `id` | `Int32` | Артикул товара |
| `date` | `Date` | Дата парсинга, без времени |
| `rootId` | `Int32` | Идентификатор, который связывает цвета товаров. Группирует несколько артикулов в один |
| `parsedAt` | `DateTime` | дата парсинга, с временем |
| `prevParsedAt` | `DateTime` | Предыдущая дата парсинга, пока что не работает |
| `kindId` | `Int32` | вероятно, что это “пол” товара(мужской, женский, для детей?) |
| `subjectId` | `Int32` | Айди предмета. Название смотреть в таблице `subjects` |
| `brandId` | `Int32` | айди бренда, название смотреть в таблице `brands` |
| `sellerId` | `Int32` | айди селлера, детальная информация в таблице `sellers` |
| `basePrice` | `Int32` | Начальная цена товара в копейках, до всех скидок |
| `price` | `Int32` | Конечная цена товара в копейках с учетом всех скидок и спп |
| `basicSale` | `Int32` | скидка ~~продавца~~ |
| `~~clientSale~~` | `~~Int32~~` | ~~со-инвест ВБ, или СПП~~ Спп теперь не парсится. Вб закрыл |
| `feedbacksCount` | `Int32` | кол-во отзывов. Сами отзывы смотреть в `feedbacks` |
| `allSalesAmount` | `Int32` | Купили более раз |
| `stocksCount` | `Int32` | кол-во  остатков, с учетом всех складов |
| `promoText` | `String` | Акция, где участвует товар |
| `stocks.wh` | `array(int)` | массив остатков: номер склада |
| `stocks.qty` | `array(int)` | массив остатков: кол-во товаров |
| `stocks.optionId` | `array(int)` | массив остатков: номер размера |
| `stocks.name` | `array(String)` | массив остатков: название размера |
| `stocks.origName` | `array(String)` | массив остатков: название размера |

## `brands`

Список брендов

| `id` | `int` |
| --- | --- |
| `name` | `String` |
| `url` | `String` |

## `sellers`

Список селлеров

| `id` | `int` | айди селлера |
| --- | --- | --- |
| `name` | `String` | имя селлера |
| `inn` | `String` | инн |
| `ogrn` | `String` | огрн |

## `feedbacks`

отзывы на товары. Только те, что видно в клиентской стороне

Фильтровать нужно по `rootId`

| `rootId` | `int` | корневой артикул товара, объединящий цвета |
| --- | --- | --- |
| `nmId` | `int` | Артикул товара в котором оставили отзыв |
| `id` | `String` | идентификатор отзыва, техническое поле |
| `wbUserId` | `int` | идентификатор пользователя |
| `wbUserName` | `String` | имя пользователя |
| `wbUserCountry` | `String` | страна пользователя |
| `text` | `String` | Текст отзыва |
| `productValuation` | `int` | кол-во звезд отзыва |
| `color` | `String` | цвет товара |
| `createdAt` | `DateTime` | дата отзыва |
| `updatedAt` | `DateTime` | дата “обновления” отзыва |
| `~~answerState~~` | `~~String~~` | ~~—~~ |
| `answerCreatedAt` | `DateTime` | дата ответа представителя бренда |
| `answerSupplierId` | `int` | — |
| `answerText` | `Strinig` | текст ответа представителя бренда |
| `photosCount` | `int` | кол-во фото в отзыве |
| `feedbackHelpfulness.wbUserId` | `array(int)` | массив `wbUserId`, оставивших лайк/дизлайк |
| `feedbackHelpfulness.helpfulness` | `array(true|false)` | массив лайков/дизлайков к отзыву |
| `feedbackHelpfulness.time` | `array(dateTime)` | массив дат, когда оставляли лайки/дизлайки |

## `productStats`

Актуальные данные об общих характеристиках товара. Здесь все данные о товаре собраны в одной таблице, удобно при работе с названиями и другими полями

поля `volume`, `country`, `numberOfItems`, `weight` извлекаются из характеристик, если в характеристиках они не заполнены, значит будут пустыми

Таблица обновляется один раз в день, где-то к 8-9 утра по мск. Дубликатов данных быть не должно, если есть - пишите [t.me/ilnur_ibatullin](http://t.me/ilnur_ibatullin)

| `id` | `Int32` | Артикул товара |
| --- | --- | --- |
| `version` | `Int64` | версия. техническое поле |
| `firstParsedAt` | `DateTime` | дата начала отслеживания товара |
| `lastParsedAt` | `DateTime` | дата последнего парсинга |
| `rootId` | `Int32` | связующий идентификатор товары внутри “цвета” |
| `subjectId` | `Int32` | айди предмета. описание в таблице `subjects` |
| `brandId` | `Int32` | айди бренда. описание в таблице `brands` |
| `sellerId` | `Int32` | айди селлера. описание в таблице `sellers` |
| `basePrice` | `Int32` | начальная цена в копейках до всех скидок |
| `price` | `Int32` | конечная цена в копейках с учетом спп и скидки продавца |
| `basicSale` | `Int32` | скидка продавца |
| `clientSale` | `Int32` | скидка ВБ(СПП) |
| `feedbacksCount` | `Int32` | количество отзывов |
| `allSalesAmount` | `Int32` | купили более раз |
| `stocksCount` | `Int32` | количество остатков |
| `brandName` | `String` | название бренда |
| `brandUrl` | `String` | `url` бренда |
| `sellerName` | `String` | название селлера |
| `sellerInn` | `String` | инн селлера |
| `sellerOgrn` | `String` | огрн селлера |
| `name` | `String` | название товара |
| `description` | `String` | описание товара |
| `contents` | `String` | — |
| `composition` | `String` | — |
| `options_name` | `Array(String)` | массив ключей характеристик |
| `options_value` | `Array(String)` | массив значений характеристик |
| `volume` | `String` | значение “Объем товара” из характеристик, в отдельном поле |
| `country` | `String` | значение “Страна производства” из характеристик |
| `weight` | `String` | значение “Вес товара с упаковкой (г)” или “Вес с упаковкой (кг)” из характеристик |
| `numberOfItems` | `String` | значение “Количество предметов в упаковке” из характеристик |
| `promoText` | `String` | Акция, где участвует товар |

## `productTexts`

История изменений контента товара

| `id` | `int` | артикул товара |
| --- | --- | --- |
| `lastModifiedAt` | `datetime` | последнее обновление товара по версии ВБ |
| `date` | `datetime` | последний парсинг после обновления |
| `name` | `String` | название товара |
| `description` | `String` | описание |
| `contents` | `String` | — |
| `composition` | `String` | — |
| `photosCount` | `int` | кол-во фото |
| `hasVideo` | `int` | наличие видео |
| `options.name` | `array(String)` | массив ключей характеристик |
| `options.value` | `array(String)` | массив значений характеристик |
| `vendorCode` | `String` | артикул селлера |
| `volume` | `String` | значение “Объем товара” из характеристик, в отдельном поле |
| `weight` | `String` | значение “Вес товара с упаковкой (г)” или “Вес с упаковкой (кг)” из характеристик |
| `numberOfItems` | `String` | значение “Количество предметов в упаковке” из характеристик |
| `country` | `String` | значение “Страна производства” из характеристик |

## `~~productStocks~~` **DEPRECATED**

История изменений остатков. Таблица для хранения истории остатков и спп товара. Может быть несколько строк в день

| `id` | `int` | артикул товара |
| --- | --- | --- |
| `parsedAt` | `datetime` | дата парсинга |
| `basePrice` | `int` | базовая цена в копейках до скидок |
| `price` | `int` | конечная цена в копейках с учетом скидок продавца и ВБ(СПП) |
| `basicSale` | `int` | скидка продавца |
| `clientSale` | `int` | скидка ВБ(СПП) |
| `stocks.wh` | `array(int)` | массив остатков: номер склада |
| `stocks.qty` | `array(int)` | массив остатков: кол-во товаров |
| `stocks.optionId` | `array(int)` | массив остатков: номер размера |
| `stocks.name` | `array(String)` | массив остатков: название размера |
| `stocks.origName` | `array(String)` | массив остатков: название размера |

## `searchInfoHistory`

история изменений частотностей запросов. пока что работает с ошибками

| `searchKeyId` | `int` | айди запроса. сам запрос хранится в `searchesDict` |
| --- | --- | --- |
| `date` | `date` | дата парсинга, без времени |
| `requestCount` | `int` | частотность запроса в месяц |
| `goodsCount` | `int` | кол-во товаров в выдаче на ВБ по этому запросу |
| `subjects.id` | `int` | массив с предметами: номер предмета |
| `subjects.count` | `int` | массив с предметами: кол-во товаров этого предмета в этом запросе |
| `normQuery` | `String` | кластер запроса |
| `preset` | `String` | какой-то `preset` |

## `feedbacksInfoHistory`

Сводные данные по отзывам, обновляются только если у товара изменился счетчик отзывов

| `rootId` | `int` | `rootId` товара. по этому столбцу отсортированы данные |
| --- | --- | --- |
| `feedbacksCount` | `date` | общее число отзывов |
| `feedbacksCountWithPhoto` | `int` | кол-во отзывов с фото |
| `feedbacksCountWithText` | `int` | кол-во отзывов с текстом |
| `valuation` | `int` | рейтинг |
| `valuation1Count` | `int` | кол-во отзывов с 1 звезд |
| `valuation2Count` | `int` | кол-во отзывов с 2 звезд |
| `valuation3Count` | `int` | кол-во отзывов с 3 звезд |
| `valuation4Count` | `int` | кол-во отзывов с 4 звезд |
| `valuation5Count` | `int` | кол-во отзывов с 5 звезд |
| `parsedAt` | `DateTime` | дата парсинга |
| `productListFeedbacksCount` | `int` | тех. столбец |
